# ðŸ”„ CLAUDE CODE HANDOFF - RiffBridge PKG Builder

## ðŸ“‹ PROJECT SUMMARY

**Project:** RiffBridge - Rocksmith PC to PS4 DLC Converter
**Current Status:** Built-in Python PKG builder created, needs testing
**Goal:** Test and validate the pure Python PKG builder implementation

---

## ðŸŽ¯ WHAT WE'VE BUILT:

### New: Pure Python PKG Builder
- **File:** `ps4_pkg_builder.py`
- **Purpose:** Build PS4 PKG files without external tools
- **Features:**
  - Parses GP4 project files (XML)
  - Creates PS4 PKG format (big-endian)
  - Writes header, entry table, file data
  - No external dependencies needed!

### Updated: Enhanced Converter
- **File:** `enhanced_converter.py`
- **Changes:**
  - Integrated Python PKG builder
  - Automatic fallback to external tools
  - Better error messages

---

## âš ï¸ CRITICAL ISSUES TO TEST:

### 1. Python PKG Builder Format â“
**STATUS:** Untested - written from specification
**NEEDS:**
- Verify big-endian encoding is correct
- Check PKG header structure matches PS4 format
- Validate entry table format
- Test file alignment (16-byte boundaries)
- Compare with real PKG files

### 2. Windows Defender Bypass â“
**STATUS:** Theory - needs validation
**NEEDS:**
- Confirm Python code doesn't trigger Windows Defender
- Test PyInstaller build with ps4_pkg_builder.py included
- Verify .exe runs without AV issues

### 3. GP4 Parsing â“
**STATUS:** Written but untested
**NEEDS:**
- Test with real GP4 files
- Verify XML parsing works
- Check file path resolution
- Validate sce_sys folder structure

### 4. PKG File Output â“
**STATUS:** Unknown if valid
**NEEDS:**
- Test if generated PKG is valid PS4 format
- Check with hex editor
- Compare structure with working PKG
- Test install on PS4 (if possible)

---

## ðŸ“ FILES TO UPLOAD TO CLAUDE CODE:

### Core Python Files (REQUIRED):
1. **ps4_pkg_builder.py** - NEW! Pure Python PKG builder
2. **enhanced_converter.py** - UPDATED with PKG builder integration
3. **rocksmith_pc_to_ps4.py** - Base converter (existing)
4. **rocksmith_gui.py** - GUI (existing)
5. **steam_dlc_database.py** - Steam metadata (existing)

### Build Scripts:
6. **BUILD_COMPLETE.bat** - PyInstaller build script
7. **requirements_gui.txt** - Python dependencies

### Assets:
8. **RiffBridge_icon.ico** - App icon
9. **Riff_Bridge_cover_art.jpg** - Band photo

### Test Files (if available):
- Sample .psarc file (PC format)
- Sample .gp4 file (GP4 project)
- Sample PS4 PKG file (for comparison)

---

## ðŸ§ª TESTING CHECKLIST:

### Phase 1: Standalone PKG Builder Test
```bash
# Test the PKG builder standalone
cd /path/to/riffbridge
python ps4_pkg_builder.py test_input.gp4 output/

# Check if PKG was created
ls -lh output/*.pkg

# Verify PKG format with hex dump
hexdump -C output/*.pkg | head -200

# Check file size is reasonable
```

**Expected Results:**
- PKG file created with Content ID as filename
- File size matches input files + headers (~45MB for test)
- Hex dump shows:
  - Magic: 7F 43 4E 54 (big-endian)
  - Type: 00 00 00 01
  - Content ID at offset 0x40

### Phase 2: Integration Test
```bash
# Test enhanced_converter imports correctly
python -c "from enhanced_converter import EnhancedRocksmithConverter; print('âœ“ Import OK')"

# Test PKG builder import
python -c "from ps4_pkg_builder import build_pkg_from_gp4; print('âœ“ Import OK')"

# Test full conversion
python enhanced_converter.py input.psarc output/ --build-pkg
```

### Phase 3: GUI Test
```bash
# Launch GUI
python rocksmith_gui.py

# Test workflow:
# 1. Drag and drop .psarc file
# 2. Check "Build Final PKG File" is enabled
# 3. Click "Convert All"
# 4. Check output directory for .pkg file
```

### Phase 4: PyInstaller Build
```bash
# Clean build
rm -rf build/ dist/

# Run build
./BUILD_COMPLETE.bat  # or equivalent

# Test executable
./dist/RiffBridge.exe

# Check if it runs
# Check if PKG builder is included
# Test conversion with GUI
```

---

## ðŸ” VALIDATION STEPS:

### 1. PKG Header Validation
```python
# Read first 256 bytes of PKG
with open('output.pkg', 'rb') as f:
    header = f.read(256)

# Check magic (big-endian)
import struct
magic = struct.unpack('>I', header[0:4])[0]
print(f"Magic: {hex(magic)}")  # Should be 0x7F434E54

# Check type
pkg_type = struct.unpack('>I', header[4:8])[0]
print(f"Type: {hex(pkg_type)}")  # Should be 0x00000001

# Check content ID
content_id = header[0x40:0x64].decode('ascii').rstrip('\x00')
print(f"Content ID: {content_id}")
```

### 2. Entry Table Validation
```python
# Check entry table offset
table_offset = struct.unpack('>I', header[0x18:0x1C])[0]
print(f"Table offset: {hex(table_offset)}")  # Should be 0x1000

# Read first entry
with open('output.pkg', 'rb') as f:
    f.seek(table_offset)
    entry = f.read(32)
    
entry_id = struct.unpack('>I', entry[0:4])[0]
file_offset = struct.unpack('>Q', entry[0x10:0x18])[0]
file_size = struct.unpack('>Q', entry[0x18:0x20])[0]

print(f"Entry ID: {hex(entry_id)}")
print(f"File offset: {hex(file_offset)}")
print(f"File size: {file_size}")
```

### 3. Compare with Real PKG
```bash
# If you have a working PS4 PKG file:
hexdump -C working.pkg | head -100 > working_header.txt
hexdump -C output.pkg | head -100 > output_header.txt
diff working_header.txt output_header.txt

# Check structure matches
```

---

## ðŸ› KNOWN POTENTIAL ISSUES:

### Issue 1: Big-Endian Encoding
**Problem:** PS4 uses big-endian, Python defaults to little-endian
**Check:** Verify all `struct.pack('>I', ...)` uses '>' prefix
**Test:** Compare hex dumps with real PKG

### Issue 2: File Alignment
**Problem:** Files must be 16-byte aligned
**Check:** Verify padding calculation: `(size + 15) & ~15`
**Test:** Check file offsets in hex dump are multiples of 16

### Issue 3: Entry IDs
**Problem:** Entry IDs must match PS4 expectations
**Check:** param.sfo=0x1000, icon0.png=0x1200
**Test:** Compare entry table with working PKG

### Issue 4: Content ID
**Problem:** Must be exactly 36 bytes, null-padded
**Check:** Content ID string handling at offset 0x40
**Test:** Hex dump should show proper null padding

### Issue 5: PyInstaller Bundling
**Problem:** ps4_pkg_builder.py might not bundle correctly
**Check:** Test imports in built .exe
**Test:** Run .exe and check for import errors

---

## ðŸŽ¯ SUCCESS CRITERIA:

### Minimum:
- âœ… PKG file is created
- âœ… No Python errors during build
- âœ… File size is reasonable
- âœ… PyInstaller includes all modules

### Good:
- âœ… PKG header structure matches specification
- âœ… Entry table is correctly formatted
- âœ… Files are properly aligned
- âœ… No Windows Defender issues

### Excellent:
- âœ… PKG installs on PS4 without errors
- âœ… Content appears in PS4 menu
- âœ… Game/DLC loads correctly
- âœ… All features working end-to-end

---

## ðŸ“š REFERENCE MATERIALS:

### PS4 PKG Format:
- **PSDevWiki:** https://www.psdevwiki.com/ps4/PKG_files
- **Format Specification:** Big-endian, 0x1000 byte header
- **Magic:** 0x7F434E54 ('CNT' with 0x7F prefix)
- **Entry Format:** 32 bytes per file

### LibOrbisPkg:
- **GitHub:** https://github.com/maxton/LibOrbisPkg
- **Reference:** C# implementation we based Python version on

### Previous Working State:
- **Last Known Good:** GP4 files created correctly
- **Issue:** External PKG tools (PkgTool.exe) blocked by Windows Defender
- **Solution:** Built-in Python PKG builder to bypass AV

---

## ðŸš€ RECOMMENDED TESTING ORDER:

1. **Upload all files to Claude Code**
2. **Test standalone PKG builder** with sample GP4
3. **Validate PKG format** with hex dump
4. **Compare** with reference PKG file
5. **Fix** any format issues
6. **Test** enhanced_converter integration
7. **Test** GUI workflow
8. **Build** with PyInstaller
9. **Test** .exe on Windows
10. **Validate** no AV issues

---

## ðŸ’¬ CONTEXT FOR CLAUDE CODE:

**Background:**
- User has Rocksmith 2014 PC DLC files (.psarc)
- Wants to convert them to PS4 format
- Need to create installable .pkg files
- Previous solutions used external tools (PkgTool.exe, orbis-pub-cmd.exe)
- External tools blocked by Windows Defender
- **Solution:** Built pure Python PKG builder

**Current State:**
- Code written but completely untested
- Based on PS4 PKG format specification
- Need to validate format is correct
- Need to test on real files
- Need to verify it works in PyInstaller build

**User Environment:**
- Windows 10/11
- Python 3.x
- PyInstaller for building .exe
- Has real Rocksmith .psarc files to test with

**Goal:**
- Create working .pkg files that install on PS4
- Avoid Windows Defender issues
- No external tool dependencies

---

## ðŸ”§ DEBUGGING COMMANDS:

```bash
# Check Python version
python --version

# Install dependencies
pip install -r requirements_gui.txt

# Test imports
python -c "import tkinter; print('âœ“ tkinter OK')"
python -c "import struct; print('âœ“ struct OK')"
python -c "import xml.etree.ElementTree; print('âœ“ xml OK')"

# Run PKG builder
python ps4_pkg_builder.py --help

# Check file structure
ls -lah
tree -L 2

# Hex dump PKG file
hexdump -C output.pkg | head -100
xxd output.pkg | head -100

# Check endianness
python -c "import sys; print(sys.byteorder)"
```

---

## ðŸ“ž QUESTIONS TO ANSWER:

1. Does the Python PKG builder create valid PS4 PKG files?
2. Is the big-endian encoding correct?
3. Are the entry IDs correct?
4. Is file alignment working?
5. Does it work in PyInstaller .exe?
6. Does Windows Defender block it?
7. Can it be installed on PS4?

---

## âœ… DELIVERABLES:

- Working `ps4_pkg_builder.py` that creates valid PKGs
- Tested `enhanced_converter.py` with PKG builder integrated
- Built `RiffBridge.exe` with no AV issues
- Validation that PKG format is correct
- Documentation of any fixes needed

---

**START HERE IN CLAUDE CODE:**
1. Upload all Python files
2. Run: `python ps4_pkg_builder.py test.gp4 output/`
3. Check: `hexdump -C output/*.pkg | head -200`
4. Compare with PKG format specification
5. Fix any issues found
6. Test full workflow

---

**Good luck! Let's make this work!** ðŸš€
